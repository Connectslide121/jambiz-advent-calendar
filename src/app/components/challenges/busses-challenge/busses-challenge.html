<div class="busses-root">
  <div class="header">
    <div class="title-row flex items-center justify-center gap-3 mb-2">
      <div class="title">{{ 'challenges.busses.title' | translate }}</div>
      <span
        *ngIf="isCompleted"
        class="bg-accent-green text-white text-xs px-2 py-1 rounded-full font-bold animate-in fade-in zoom-in flex items-center gap-1"
      >
        <lucide-icon [img]="Check" class="w-3 h-3" [strokeWidth]="4"></lucide-icon>
        {{ 'calendar.completed' | translate }}
      </span>
    </div>
    <p class="instruction">{{ 'challenges.busses.instruction' | translate }}</p>
  </div>

  <div class="stats" role="status" aria-live="polite">
    <div class="stat">
      <span class="label">{{ 'challenges.busses.timesPlayed' | translate }}</span>
      <span class="value">{{ timesPlayed }}</span>
    </div>
    <div class="stat">
      <span class="label">{{ 'challenges.busses.carsLeft' | translate }}</span>
      <span class="value">{{ carsLeft }}</span>
    </div>
    <div class="stat">
      <span class="label">{{ 'challenges.busses.crashes' | translate }}</span>
      <span class="value">{{ crashes }}</span>
    </div>
  </div>

  <div class="actions">
    <button class="btn btn-outline" (click)="resetGrid()">
      {{ 'challenges.busses.reset' | translate }}
    </button>
  </div>

  <div class="grid-area" role="grid" aria-label="Bus parking grid">
    <div class="grid">
      <ng-container *ngFor="let row of cells; let r = index">
        <div class="row">
          <ng-container *ngFor="let cell of row; let c = index">
            <div class="cell {{ cellClasses(r, c) }}"></div>
          </ng-container>
        </div>
      </ng-container>
    </div>
    <div class="bus-overlay">
      <ng-container *ngFor="let bus of buses">
        <div
          class="bus-target-cell"
          [style.gridRowStart]="bus.row + 1"
          [style.gridColumnStart]="bus.col + 1"
          role="gridcell"
          aria-label="Bus"
        >
              <i
                class="fa-solid {{ iconFor() }} {{ bus.animating }} bus-icon"
                [style.color]="bus.color"
                [style.transform]="getTransform(bus.angle ?? angleForDir(bus.dir), bus.offsetX ?? 0, bus.offsetY ?? 0)"
                [style.transition-timing-function]="bus.timing || 'ease-in-out'"
                [style.--bus-transition-duration]="moveDuration"
                (click)="onClickBus(bus)"
              ></i>
          <span *ngIf="bus.exploding" class="explosion">
            <i class="fa-solid fa-burst"></i>
          </span>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Win message when all buses cleared -->
  <div class="win-message card bg-accent-green p-4 text-center my-4" *ngIf="buses.length === 0">
    <p class="text-lg sm:text-xl font-bold text-white">
      {{ 'challenges.busses.win' | translate }}
    </p>
  </div>

  <!-- Action buttons when completed -->
  <div class="actions flex flex-col sm:flex-row justify-center gap-3 mt-4" *ngIf="isCompleted">
    <button class="btn btn-primary w-full sm:w-auto" (click)="showReward()" type="button">
      {{ 'ui.showReward' | translate }}
    </button>
    <button class="btn btn-outline w-full sm:w-auto" (click)="playAgain()" type="button">
      {{ 'ui.playAgain' | translate }}
    </button>
  </div>

  <!-- Previously completed stats -->
  <div class="text-center text-text-muted text-sm mt-2" *ngIf="isCompleted && savedCrashes !== null">
    {{ 'challenges.busses.previouslyCompleted' | translate : { crashes: savedCrashes } }}
  </div>
</div>
