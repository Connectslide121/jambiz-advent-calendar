<div class="flex flex-col items-center gap-6 p-4">
  <h2 class="text-2xl font-bold text-center text-gold">
    {{ 'challenges.climber.title' | translate }}
  </h2>

  <!-- Instructions - always visible -->
  <div class="card max-w-md text-center space-y-4">
    @if (isInfiniteMode) {
    <p class="text-text-muted">
      {{ 'challenges.climber.endless.tagline' | translate }}
    </p>
    } @else {
    <p class="text-text-muted">{{ 'challenges.climber.instruction' | translate }}</p>
    }

    <div class="text-sm text-text-muted space-y-2">
      @if (isMobile()) {
      <p>{{ 'challenges.climber.controlsMobile' | translate }}</p>
      } @else {
      <p>{{ 'challenges.climber.controlsDesktop' | translate }}</p>
      }

      <div class="flex items-center justify-center gap-3 mt-4">
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded" style="background-color: #2a9d8f"></div>
          <span class="text-xs">{{ 'challenges.climber.staticPlatform' | translate }}</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded" style="background-color: #f4d35e"></div>
          <span class="text-xs">{{ 'challenges.climber.movingPlatform' | translate }}</span>
        </div>
        <div class="flex items-center gap-2">
          <div class="w-4 h-4 rounded" style="background-color: #a8dadc"></div>
          <span class="text-xs">{{ 'challenges.climber.icePlatform' | translate }}</span>
        </div>
      </div>
    </div>

    @if (isInfiniteMode) {
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-left">
      <div class="rounded-lg border border-gray-700 bg-surface/70 p-3">
        <p class="text-xs uppercase tracking-wide text-text-muted">
          {{ 'challenges.climber.endless.bestHeight' | translate }}
        </p>
        <p class="text-xl font-bold text-gold">{{ bestHeight | number : '1.0-0' }} m</p>
      </div>
      <div class="rounded-lg border border-gray-700 bg-surface/70 p-3">
        <p class="text-xs uppercase tracking-wide text-text-muted">
          {{ 'challenges.climber.endless.bestTime' | translate }}
        </p>
        <p class="text-xl font-bold text-gold">
          {{ bestTimeFormatted }}
        </p>
      </div>
      <div class="rounded-lg border border-gray-700 bg-surface/70 p-3">
        <p class="text-xs uppercase tracking-wide text-text-muted">
          {{ 'challenges.climber.endless.lastHeight' | translate }}
        </p>
        <p class="text-xl font-bold text-gold">
          @if (lastRunHeight > 0) {
          {{ lastRunHeight | number : '1.0-0' }} m } @else { -- }
        </p>
      </div>
      <div class="rounded-lg border border-gray-700 bg-surface/70 p-3">
        <p class="text-xs uppercase tracking-wide text-text-muted">
          {{ 'challenges.climber.endless.lastTime' | translate }}
        </p>
        <p class="text-xl font-bold text-gold">
          @if (lastRunTime > 0) {
          {{ lastRunTimeFormatted }}
          } @else { -- }
        </p>
      </div>
    </div>
    } @if (!isCompleted && !gameStarted()) {
    <button class="btn btn-primary" (click)="startGame()">
      {{ 'challenges.climber.startGame' | translate }}
    </button>
    }
  </div>

  <!-- Game Canvas - always visible -->
  <div class="relative" (pointerdown)="onJump($event)">
    <canvas
      #gameCanvas
      class="border-2 border-gold rounded-lg shadow-lg"
      style="image-rendering: pixelated"
    ></canvas>

    <!-- Game Over Overlay -->
    @if (gameLost()) {
    <div
      class="absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center gap-4 rounded-lg"
    >
      <p class="text-xl font-bold text-accent-red">
        @if (isInfiniteMode) {
        {{ 'challenges.climber.endless.gameLost' | translate }}
        } @else {
        {{ 'challenges.climber.gameLost' | translate }}
        }
      </p>
      @if (isInfiniteMode) {
      <div class="text-text text-sm sm:text-base space-y-1">
        <p>
          {{ 'challenges.climber.endless.lastHeight' | translate }}:
          <span class="font-semibold">{{ lastRunHeight | number : '1.0-0' }} m</span>
        </p>
        <p>
          {{ 'challenges.climber.endless.lastTime' | translate }}:
          <span class="font-semibold">{{ lastRunTimeFormatted }}</span>
        </p>
      </div>
      }
      <button class="btn btn-primary" (click)="restartGame()">
        {{ 'ui.tryAgain' | translate }}
      </button>
    </div>
    }

    <!-- Win Overlay -->
    @if (gameWon() && !isInfiniteMode) {
    <div
      class="absolute inset-0 bg-black bg-opacity-75 flex flex-col items-center justify-center gap-4 rounded-lg"
    >
      <p class="text-2xl font-bold text-gold">
        {{ 'challenges.climber.success' | translate }}
      </p>
      <p class="text-text-muted text-sm">
        {{ 'challenges.climber.ornamentsCollected' | translate }}: {{ collectedCount }}/{{
          totalCollectibles
        }}
      </p>
    </div>
    }
  </div>

  <!-- Mobile Touch Controls -->
  @if (isMobile() && gameStarted() && !gameWon() && !gameLost()) {
  <app-touch-controls
    (directionChange)="onDirectionChange($event)"
    (jump)="onJump()"
    [showJoystick]="false"
    [showActionButton]="false"
  />
  }

  <!-- Replay Button -->
  @if (isCompleted && !gameStarted()) {
  <button class="btn btn-outline" (click)="restartGame()">
    {{ 'ui.playAgain' | translate }}
  </button>
  }
</div>
