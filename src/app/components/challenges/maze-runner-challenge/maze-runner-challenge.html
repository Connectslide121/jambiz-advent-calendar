<div class="flex flex-col items-center gap-2 sm:gap-4 p-2 w-full h-full max-h-full overflow-hidden">
  <!-- Title and Instructions -->
  <div class="text-center shrink-0 landscape:hidden lg:landscape:block">
    <div class="flex items-center justify-center gap-3 mb-1">
      <h2 class="text-xl sm:text-2xl font-bold text-gold">
        游꾸 {{ 'challenges.mazeRunner.title' | translate }} 游꾸
      </h2>
      <span
        *ngIf="isCompleted"
        class="bg-accent-green text-white text-xs px-2 py-1 rounded-full font-bold animate-in fade-in zoom-in flex items-center gap-1"
      >
        <lucide-icon [img]="Check" class="w-3 h-3" [strokeWidth]="4"></lucide-icon>
        {{ 'calendar.completed' | translate }}
      </span>
    </div>
    <p class="text-text-muted text-xs sm:text-base hidden sm:block">
      {{ 'challenges.mazeRunner.instruction' | translate }}
    </p>
  </div>

  <!-- Compact Title for Landscape Mobile -->
  <div class="text-center shrink-0 hidden landscape:block lg:landscape:hidden">
    <div class="flex items-center justify-center gap-2">
      <h2 class="text-lg font-bold text-gold">
        游꾸 {{ 'challenges.mazeRunner.title' | translate }} 游꾸
      </h2>
      <span
        *ngIf="isCompleted"
        class="bg-accent-green text-white text-[10px] px-1.5 py-0.5 rounded-full font-bold flex items-center gap-1"
      >
        <lucide-icon [img]="Check" class="w-3 h-3" [strokeWidth]="4"></lucide-icon>
      </span>
    </div>
  </div>

  <!-- Game Area (Grid + Controls) -->
  <div
    class="flex flex-col landscape:flex-row lg:flex-row items-center justify-center gap-2 sm:gap-4 w-full flex-1 min-h-0"
  >
    <!-- Game Grid Container -->
    <div
      class="relative flex items-center justify-center max-w-full max-h-full overflow-auto p-1 sm:p-2"
    >
      <div class="maze-grid bg-surface border-2 border-gray-700 rounded-lg p-1 sm:p-2 shadow-2xl">
        <div *ngFor="let row of grid; let rowIndex = index" class="flex">
          <div
            *ngFor="let cell of row; let colIndex = index"
            class="relative transition-colors duration-200"
            [ngClass]="getCellClass(rowIndex, colIndex)"
          >
            <!-- Player -->
            <div
              *ngIf="playerPos.x === colIndex && playerPos.y === rowIndex"
              class="absolute inset-0.5 z-20"
            >
              <img
                src="assets/sprites/player.png"
                class="w-full h-full object-contain drop-shadow-lg animate-bounce"
                alt="Player"
              />
            </div>

            <!-- Collectible -->
            <div
              *ngIf="isCollectible(colIndex, rowIndex)"
              class="absolute inset-0 sm:inset-1 z-10 animate-pulse"
            >
              <img
                src="assets/sprites/gift.png"
                class="w-full h-full object-contain drop-shadow-md"
                alt="Gift"
              />
            </div>
            <!-- Goal -->
            <div
              *ngIf="grid[rowIndex][colIndex] === 'goal'"
              class="absolute inset-0 flex items-center justify-center z-0"
              [class.opacity-50]="collectibles.length > 0"
            >
              <img
                src="assets/sprites/tree.png"
                class="w-full h-full object-contain drop-shadow-lg"
                alt="Goal"
              />
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sidebar (Stats + Controls) -->
    <div
      class="flex flex-col landscape:justify-center gap-1 sm:gap-4 shrink-0 z-10 w-full sm:w-auto"
    >
      <!-- Stats -->
      <div class="flex flex-row sm:flex-col gap-2 w-full justify-center">
        <div
          class="bg-surface border border-gray-700 rounded-lg p-1 sm:p-3 flex-1 sm:flex-none min-w-[80px] sm:min-w-[120px] shadow-lg"
        >
          <div class="text-[10px] sm:text-xs text-text-muted text-center mb-0.5">
            {{ 'challenges.mazeRunner.moves' | translate }}
          </div>
          <div class="text-base sm:text-2xl font-bold text-gold text-center leading-tight">
            {{ moveCount }}
          </div>
        </div>

        <div
          class="bg-surface border border-gray-700 rounded-lg p-1 sm:p-3 flex-1 sm:flex-none min-w-[80px] sm:min-w-[120px] shadow-lg"
          *ngIf="collectibleCount > 0"
        >
          <div class="text-[10px] sm:text-xs text-text-muted text-center mb-0.5">
            {{ 'challenges.mazeRunner.gifts' | translate }}
          </div>
          <div class="text-base sm:text-2xl font-bold text-accent-red text-center leading-tight">
            {{ collectedCount }} / {{ collectibleCount }}
          </div>
        </div>
      </div>

      <!-- D-Pad Controls (Mobile/Touch) -->
      <div
        class="grid grid-cols-3 gap-1 sm:gap-2 p-1 sm:p-2 bg-surface/50 rounded-xl border border-gray-700/50 lg:hidden"
      >
        <div></div>
        <button
          class="btn btn-secondary p-1 sm:p-3 landscape:p-1.5 flex items-center justify-center active:scale-95 transition-transform touch-manipulation"
          (click)="move('up')"
          [disabled]="isWon"
          aria-label="Move Up"
        >
          <lucide-icon
            [img]="ArrowUp"
            class="w-5 h-5 sm:w-6 sm:h-6 landscape:w-5 landscape:h-5"
          ></lucide-icon>
        </button>
        <div></div>

        <button
          class="btn btn-secondary p-1 sm:p-3 landscape:p-1.5 flex items-center justify-center active:scale-95 transition-transform touch-manipulation"
          (click)="move('left')"
          [disabled]="isWon"
          aria-label="Move Left"
        >
          <lucide-icon
            [img]="ArrowLeft"
            class="w-5 h-5 sm:w-6 sm:h-6 landscape:w-5 landscape:h-5"
          ></lucide-icon>
        </button>
        <button
          class="btn btn-secondary p-1 sm:p-3 landscape:p-1.5 flex items-center justify-center active:scale-95 transition-transform touch-manipulation"
          (click)="move('down')"
          [disabled]="isWon"
          aria-label="Move Down"
        >
          <lucide-icon
            [img]="ArrowDown"
            class="w-5 h-5 sm:w-6 sm:h-6 landscape:w-5 landscape:h-5"
          ></lucide-icon>
        </button>
        <button
          class="btn btn-secondary p-1 sm:p-3 landscape:p-1.5 flex items-center justify-center active:scale-95 transition-transform touch-manipulation"
          (click)="move('right')"
          [disabled]="isWon"
          aria-label="Move Right"
        >
          <lucide-icon
            [img]="ArrowRight"
            class="w-5 h-5 sm:w-6 sm:h-6 landscape:w-5 landscape:h-5"
          ></lucide-icon>
        </button>
      </div>

      <!-- Action Buttons -->
      <div class="flex gap-2 justify-center">
        <button
          class="btn btn-outline p-1 sm:p-2 flex-1 flex justify-center"
          (click)="reset()"
          title="{{ 'ui.reset' | translate }}"
          *ngIf="!isWon"
        >
          <lucide-icon [img]="RotateCcw" class="w-4 h-4 sm:w-5 sm:h-5"></lucide-icon>
        </button>

        <button
          *ngIf="isWon"
          class="btn btn-primary w-full py-1 sm:py-2 text-sm sm:text-base"
          (click)="reset()"
        >
          {{ 'ui.playAgain' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Win Message -->
  <div
    *ngIf="isWon && !isCompleted"
    class="absolute inset-0 flex items-center justify-center bg-black/80 z-50 backdrop-blur-sm"
  >
    <div
      class="bg-surface border-2 border-accent-green rounded-xl p-8 text-center shadow-2xl transform scale-100 animate-in fade-in zoom-in duration-300"
    >
      <h3 class="text-3xl font-bold text-accent-green mb-2">
        {{ 'challenges.mazeRunner.success' | translate }}
      </h3>
      <p class="text-text-muted mb-6">
        {{ 'challenges.mazeRunner.completedIn' | translate : { moves: moveCount } }}
      </p>
      <button class="btn btn-primary w-full" (click)="completed.emit()">
        {{ 'ui.continue' | translate }}
      </button>
    </div>
  </div>
</div>
