<div class="calendar-container">
  <!-- Calendar Grid -->
  <div class="calendar-grid grid grid-cols-6 gap-1 sm:gap-1.5 lg:gap-2">
    @for (dayConfig of calendarDays; track dayConfig.day) {
    <div class="day-tile-wrapper relative">
      <!-- Custom Tooltip -->
      @if (dayConfig.challengeType) {
      <div class="tooltip">
        @if (isDayLocked(dayConfig)) {
        {{ 'calendar.locked' | translate }}
        } @else {
        {{ getChallengeTitleKey(dayConfig.challengeType) | translate }}
        }
      </div>
      }
      <button
        class="day-tile card relative overflow-hidden transition-all duration-300"
        [class.completed]="isDayCompleted(dayConfig.day)"
        [class.unpopulated]="!dayConfig.challengeType"
        [class.locked]="isDayLocked(dayConfig)"
        [class.hover:scale-105]="dayConfig.challengeType && !isDayLocked(dayConfig)"
        [class.hover:shadow-xl]="dayConfig.challengeType && !isDayLocked(dayConfig)"
        [disabled]="!dayConfig.challengeType || isDayLocked(dayConfig)"
        (click)="onDaySelected(dayConfig)"
        [attr.aria-label]="'Day ' + dayConfig.day"
      >
        <!-- Puzzle Image Piece (revealed when completed) -->
        <div
          class="puzzle-piece absolute inset-0 transition-opacity duration-500"
          [class.revealed]="isDayCompleted(dayConfig.day)"
          [ngStyle]="getPuzzlePieceStyle(dayConfig.gridPosition)"
        ></div>

        <!-- Challenge Emoji - Tilted and Clipped -->
        @if (dayConfig.challengeType) {
        <div
          class="challenge-emoji"
          [class.grayscale]="!isDayCompleted(dayConfig.day)"
          [class.completed-emoji]="isDayCompleted(dayConfig.day)"
        >
          {{ getChallengeEmoji(dayConfig.challengeType) }}
        </div>
        }

        <!-- Day Number (always visible) -->
        <div
          class="day-number font-bold text-gold mb-0 sm:mb-1 z-20 transition-all duration-300"
          [class.text-shadow-strong]="isDayCompleted(dayConfig.day)"
        >
          {{ dayConfig.day }}
        </div>

        <!-- Coming Soon Indicator -->
        @if (!dayConfig.challengeType) {
        <div class="text-[8px] sm:text-xs text-text-muted opacity-70 z-10 text-center px-1">
          {{ 'calendar.comingSoon' | translate }}
        </div>
        }

        <!-- Completion Indicator -->
        @if (isDayCompleted(dayConfig.day)) {
        <div
          class="absolute top-0.5 right-0.5 sm:top-1 sm:right-1 md:top-2 md:right-2 bg-accent-green rounded-full p-0.5 sm:p-1 z-20"
        >
          <lucide-icon
            [img]="Check"
            class="w-2 h-2 sm:w-3 sm:h-3 md:w-4 md:h-4 text-white"
            [strokeWidth]="3"
          ></lucide-icon>
        </div>
        }

        <!-- Locked Indicator - Corner lock icon with countdown for next unlock -->
        @if (isDayLocked(dayConfig)) { @if (isNextToUnlock(dayConfig.day) && countdown) {
        <!-- Countdown for next unlock - at top -->
        <div
          class="absolute inset-x-0 top-2 sm:top-3 md:top-4 flex justify-center z-20 pointer-events-none"
        >
          <div class="countdown-container text-center">
            <div class="text-[6px] sm:text-[8px] text-text-muted uppercase tracking-wide">
              {{ 'calendar.unlocksIn' | translate }}
            </div>
            <div
              class="countdown-timer text-[10px] sm:text-xs md:text-sm font-mono font-bold text-gold"
            >
              {{ countdown }}
            </div>
          </div>
        </div>
        }
        <!-- Lock icon in corner -->
        <div
          class="absolute top-0.5 right-0.5 sm:top-1 sm:right-1 md:top-2 md:right-2 bg-black/60 rounded-full p-0.5 sm:p-1 z-20 pointer-events-none"
        >
          <lucide-icon
            [img]="Lock"
            class="w-2.5 h-2.5 sm:w-3.5 sm:h-3.5 md:w-4 md:h-4 text-text-muted"
            [strokeWidth]="2"
          ></lucide-icon>
        </div>
        }

        <!-- Hover Effect Overlay -->
        <div
          class="absolute inset-0 bg-accent-red opacity-0 hover:opacity-10 transition-opacity duration-300 pointer-events-none z-10"
        ></div>
      </button>
    </div>
    }
  </div>

  <!-- Day 25 - The Big Day -->
  <div class="day25-tile mt-2 sm:mt-3 lg:mt-4">
    <div
      class="card relative overflow-hidden transition-all duration-300 p-4 sm:p-6 lg:p-8"
      [class.day25-unlocked]="isUnlocked()"
      [class.day25-locked]="!isUnlocked()"
    >
      <!-- Background decoration -->
      <div class="absolute inset-0 overflow-hidden pointer-events-none">
        <div class="absolute -top-4 -left-4 text-6xl sm:text-8xl opacity-10 transform -rotate-12">
          üéÑ
        </div>
        <div
          class="absolute -bottom-4 -right-4 text-6xl sm:text-8xl opacity-10 transform rotate-12"
        >
          üéÅ
        </div>
        @if (isUnlocked()) {
        <div class="absolute top-1/2 left-1/4 text-4xl opacity-20 animate-pulse">‚ú®</div>
        <div
          class="absolute top-1/3 right-1/4 text-4xl opacity-20 animate-pulse"
          style="animation-delay: 0.5s"
        >
          ‚ú®
        </div>
        }
      </div>

      <!-- Content -->
      <div class="relative z-10 flex flex-col items-center text-center">
        <!-- Status Message -->
        @if (isUnlocked()) {
        <p class="text-base sm:text-lg text-accent-green font-semibold mb-4">
          {{ 'calendar.day25.unlocked' | translate }}
        </p>
        } @else {
        <p class="text-sm sm:text-base text-text-muted mb-4 max-w-md">
          {{ 'rewards.unlockHint' | translate : { completed: getCompletedCount(), total: 24 } }}
        </p>
        }

        <!-- Action Buttons -->
        <div
          class="flex flex-col sm:flex-row items-center justify-center gap-3 sm:gap-4 w-full sm:w-auto"
        >
          <!-- Rewards Gallery Button -->
          <button
            class="btn px-5 sm:px-6 py-2.5 sm:py-3 text-sm sm:text-base lg:text-lg font-bold flex items-center gap-2 w-full sm:w-auto justify-center"
            [class.btn-primary]="isUnlocked()"
            [class.btn-outline]="!isUnlocked()"
            [class.opacity-50]="!isUnlocked()"
            [class.cursor-not-allowed]="!isUnlocked()"
            [disabled]="!isUnlocked()"
            (click)="onOpenRewardsGallery()"
          >
            @if (!isUnlocked()) {
            <lucide-icon [img]="Lock" class="w-4 h-4 sm:w-5 sm:h-5" [strokeWidth]="2"></lucide-icon>
            } üèÜ {{ 'rewards.galleryButton' | translate }}
          </button>

          <!-- Extras Button -->
          <button
            class="btn px-5 sm:px-6 py-2.5 sm:py-3 text-sm sm:text-base lg:text-lg font-bold flex items-center gap-2 w-full sm:w-auto justify-center"
            [class.btn-secondary]="isUnlocked()"
            [class.btn-outline]="!isUnlocked()"
            [class.opacity-50]="!isUnlocked()"
            [class.cursor-not-allowed]="!isUnlocked()"
            [disabled]="!isUnlocked()"
            (click)="onOpenExtras()"
          >
            @if (!isUnlocked()) {
            <lucide-icon [img]="Lock" class="w-4 h-4 sm:w-5 sm:h-5" [strokeWidth]="2"></lucide-icon>
            } üéÅ {{ 'extras.button' | translate }} üéÅ
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Challenge Modal -->
  @if (selectedDay) {
  <app-challenge-host
    [dayConfig]="selectedDay"
    [isCompleted]="isDayCompleted(selectedDay.day)"
    (close)="onCloseChallenge()"
    (challengeCompleted)="onChallengeCompleted()"
  ></app-challenge-host>
  }
</div>
