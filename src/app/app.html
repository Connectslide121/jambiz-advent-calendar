<!-- Jambiz Advent Calendar App -->

<div class="min-h-screen flex flex-col bg-gradient-to-b from-bg to-surface relative">
  <!-- Global Snowflakes -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden z-0">
    @for (snowflake of snowflakes; track $index) {
    <div
      class="snowflake absolute text-white"
      [style.left.%]="snowflake.left"
      [style.top.px]="snowflake.startY"
      [style.animation-duration.s]="snowflake.animationDuration"
      [style.animation-delay.s]="snowflake.animationDelay"
      [style.font-size.px]="snowflake.fontSize"
      [style.opacity]="snowflake.opacity"
    >
      ‚ùÑ
    </div>
    }
  </div>

  @if (showLandingPage) {
  <!-- Language Toggle for Landing Page -->
  <div class="absolute top-4 right-4 z-20">
    <button
      (click)="toggleLanguage()"
      class="btn btn-outline text-sm px-3 py-2"
      [attr.aria-label]="'Switch to ' + (currentLanguage === 'sv' ? 'English' : 'Swedish')"
    >
      {{ currentLanguage === 'sv' ? 'EN' : 'SV' }}
    </button>
  </div>

  <app-landing-page
    (start)="startCalendar()"
    (showInfo)="openInfoModal()"
    class="flex-1 flex items-center justify-center relative z-10"
  ></app-landing-page>
  } @else {
  <!-- Header -->
  <header class="bg-surface border-b-2 border-accent-red shadow-lg relative z-10">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 sm:py-4">
      <div class="flex items-center justify-between gap-4">
        <!-- Logo and Title -->
        <div class="flex items-center gap-3 sm:gap-4 flex-1">
          <div class="bg-white rounded-lg p-2 sm:p-2.5 shadow-md">
            <img
              src="assets/Jambiz_xmas_logo.png"
              alt="Jambiz Logo"
              class="h-12 w-20 sm:h-14 sm:w-24 lg:h-16 lg:w-32 object-contain"
            />
          </div>
          <div class="text-left">
            <h1 class="text-xl sm:text-2xl lg:text-3xl font-bold text-text leading-tight">
              {{ 'app.title' | translate }}
            </h1>
            <p class="text-xs sm:text-sm text-text-muted mt-0.5 sm:mt-1">
              {{ 'app.subtitle' | translate }}
            </p>
          </div>
        </div>

        <!-- Controls Container - wraps on mobile -->
        <div class="flex flex-wrap items-center gap-2 sm:gap-3 justify-end">
          <!-- Language Toggle - Single Button -->
          <button
            (click)="toggleLanguage()"
            class="btn btn-outline shrink-0 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2 min-w-[3rem] sm:min-w-[3.5rem]"
            [attr.aria-label]="'Switch to ' + (currentLanguage === 'sv' ? 'English' : 'Swedish')"
          >
            {{ currentLanguage === 'sv' ? 'EN' : 'SV' }}
          </button>

          <!-- Dev Mode Toggle Button -->
          <button
            (click)="calendarState.toggleDevMode()"
            class="btn shrink-0 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2"
            [class.btn-secondary]="calendarState.devMode"
            [class.btn-outline]="!calendarState.devMode"
            [attr.aria-label]="'Toggle developer mode'"
            title="Dev Mode: {{ calendarState.devMode ? 'ON' : 'OFF' }} (unlocks all days)"
          >
            <lucide-icon [img]="Code" class="w-4 h-4 sm:w-5 sm:h-5" [strokeWidth]="2"></lucide-icon>
          </button>

          <!-- Date Override Input (for testing) -->
          <div class="flex items-center gap-1">
            <input
              type="number"
              min="1"
              max="31"
              [value]="calendarState.dateOverride ?? ''"
              (input)="onDateOverrideChange($event)"
              placeholder="Day"
              class="w-14 px-2 py-1.5 text-xs sm:text-sm bg-surface border border-border rounded text-text text-center"
              title="Set fake December day (1-31) for testing"
            />
            @if (calendarState.dateOverride !== null) {
            <button
              (click)="calendarState.dateOverride = null"
              class="btn btn-outline p-1 min-w-0"
              title="Clear date override"
            >
              <lucide-icon [img]="X" class="w-3 h-3" [strokeWidth]="2"></lucide-icon>
            </button>
            }
          </div>

          <!-- Mark All Complete Button -->
          <button
            (click)="markAllComplete()"
            class="btn btn-secondary shrink-0 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2"
            [attr.aria-label]="'Mark all challenges as completed'"
            title="{{ 'admin.markAllComplete' | translate }}"
          >
            <lucide-icon
              [img]="CheckCheck"
              class="w-4 h-4 sm:w-5 sm:h-5"
              [strokeWidth]="2"
            ></lucide-icon>
          </button>

          <!-- Clear All Progress Button -->
          <button
            (click)="clearAllProgress()"
            class="btn btn-primary shrink-0 text-xs sm:text-sm px-2 sm:px-3 py-1.5 sm:py-2"
            [attr.aria-label]="'Clear all progress'"
            title="{{ 'admin.clearAll' | translate }}"
          >
            <lucide-icon
              [img]="XCircle"
              class="w-4 h-4 sm:w-5 sm:h-5"
              [strokeWidth]="2"
            ></lucide-icon>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 max-w-7xl w-full mx-auto px-4 sm:px-6 lg:px-8 py-8 relative z-10">
    <!-- Info Button -->
    <div class="flex justify-center mb-6">
      <button
        (click)="openInfoModal()"
        class="btn btn-outline px-4 py-2 text-sm sm:text-base flex items-center gap-2"
      >
        <lucide-icon [img]="Info" class="w-4 h-4 sm:w-5 sm:h-5" [strokeWidth]="2"></lucide-icon>
        {{ 'info.button' | translate }}
      </button>
    </div>

    <app-calendar></app-calendar>

    <!-- Action Buttons -->
    <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
      <!-- Rewards Gallery Button (only when unlocked) -->
      <button
        class="btn px-6 py-3 text-base sm:text-lg font-bold flex items-center gap-2"
        [class.btn-primary]="isUnlocked()"
        [class.btn-outline]="!isUnlocked()"
        [class.opacity-50]="!isUnlocked()"
        [class.cursor-not-allowed]="!isUnlocked()"
        [disabled]="!isUnlocked()"
        (click)="openRewardsGallery()"
        [title]="isUnlocked() ? '' : ('rewards.lockedHint' | translate)"
      >
        @if (!isUnlocked()) {
        <lucide-icon [img]="Lock" class="w-5 h-5" [strokeWidth]="2"></lucide-icon>
        } üèÜ {{ 'rewards.galleryButton' | translate }}
      </button>

      <!-- Extras Button -->
      <button
        class="btn px-6 py-3 text-base sm:text-lg font-bold flex items-center gap-2"
        [class.btn-secondary]="isUnlocked()"
        [class.btn-outline]="!isUnlocked()"
        [class.opacity-50]="!isUnlocked()"
        [class.cursor-not-allowed]="!isUnlocked()"
        [disabled]="!isUnlocked()"
        (click)="openExtras()"
        [title]="isUnlocked() ? '' : ('extras.lockedHint' | translate)"
      >
        @if (!isUnlocked()) {
        <lucide-icon [img]="Lock" class="w-5 h-5" [strokeWidth]="2"></lucide-icon>
        } üéÅ {{ 'extras.button' | translate }} üéÅ
      </button>
    </div>

    <!-- Unlock hint when not complete -->
    @if (!isUnlocked()) {
    <p class="text-center text-text-muted text-sm mt-4">
      {{
        'rewards.unlockHint'
          | translate : { completed: calendarState.getCompletedCount(), total: 24 }
      }}
    </p>
    }
  </main>
  }
</div>

<!-- Extras Menu Modal -->
@if (showExtrasMenu) {
<div class="modal-overlay" (click)="closeExtrasMenu()">
  <div
    class="modal-content w-full h-full lg:w-[90vw] lg:max-w-5xl lg:max-h-[90vh] lg:rounded-2xl flex flex-col overflow-hidden"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-shrink-0">
      <div class="flex items-center gap-4">
        <h2 class="text-2xl sm:text-3xl font-bold text-text">
          üéÅ {{ 'extras.title' | translate }} üéÅ
        </h2>
      </div>
      <button (click)="closeExtrasMenu()" class="btn btn-outline p-2 min-w-0" aria-label="Close">
        <lucide-icon [img]="X" class="w-6 h-6" [strokeWidth]="2"></lucide-icon>
      </button>
    </div>

    <!-- Extras Content -->
    <div class="flex-1 overflow-y-auto">
      @if (!selectedGame) {
      <!-- Game Selection View -->
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
        @for (game of extraLevels; track game.type) {
        <button
          (click)="selectGame(game)"
          class="card p-6 text-left hover:bg-opacity-80 transition-all cursor-pointer"
          [class.border-2]="getCompletionCount(game).completed === getCompletionCount(game).total"
          [class.border-accent-green]="
            getCompletionCount(game).completed === getCompletionCount(game).total
          "
        >
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
              <span class="text-5xl">{{ getGameIcon(game.type) }}</span>
              <div>
                <h3 class="text-xl font-bold text-text">
                  {{ 'extras.games.' + game.type + '.title' | translate }}
                </h3>
                <p class="text-sm text-text-muted">
                  {{ getCompletionCount(game).completed }}/{{ getCompletionCount(game).total }}
                  {{ 'extras.levelsCompleted' | translate }}
                </p>
              </div>
            </div>
            @if (getCompletionCount(game).completed === getCompletionCount(game).total) {
            <lucide-icon
              [img]="Check"
              class="w-8 h-8 text-accent-green"
              [strokeWidth]="3"
            ></lucide-icon>
            }
          </div>
        </button>
        }
      </div>
      } @else {
      <!-- Level Selection View -->
      <div class="mb-6 pb-6 border-b border-surface flex items-center gap-4">
        <button
          (click)="backToGameSelection()"
          class="btn btn-outline p-2 min-w-0"
          aria-label="Back"
        >
          <lucide-icon [img]="ArrowLeft" class="w-6 h-6" [strokeWidth]="2"></lucide-icon>
        </button>

        <span class="text-6xl">{{ getGameIcon(selectedGame.type) }}</span>
        <div>
          <h3 class="text-2xl font-bold text-text mb-2">
            {{ 'extras.games.' + selectedGame.type + '.title' | translate }}
          </h3>
          <p class="text-text-muted">
            {{ getCompletionCount(selectedGame).completed }}/{{
              getCompletionCount(selectedGame).total
            }}
            {{ 'extras.levelsCompleted' | translate }}
          </p>
        </div>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        @for (level of selectedGame.levels; track level.id) {
        <button
          (click)="selectExtra(level)"
          class="card p-6 text-left hover:bg-opacity-80 transition-all"
          [class.border-2]="isExtraCompleted(level.id)"
          [class.border-accent-green]="isExtraCompleted(level.id)"
        >
          <div class="flex items-start justify-between mb-3">
            <h4 class="text-lg font-bold text-text">
              {{ level.nameKey | translate }}
            </h4>
            @if (isExtraCompleted(level.id)) {
            <lucide-icon
              [img]="Check"
              class="w-6 h-6 text-accent-green"
              [strokeWidth]="3"
            ></lucide-icon>
            }
          </div>
          <p class="text-sm text-text-muted">
            {{ level.descriptionKey | translate }}
          </p>
        </button>
        }
      </div>
      }
    </div>
  </div>
</div>
}

<!-- Extra Challenge Modal (using ChallengeHost) -->
@if (showExtraChallenge && selectedExtraConfig) {
<app-challenge-host
  [dayConfig]="selectedExtraConfig"
  [isCompleted]="selectedExtraId ? isExtraCompleted(selectedExtraId) : false"
  (close)="closeExtraChallenge()"
  (challengeCompleted)="onExtraChallengeCompleted()"
></app-challenge-host>
}

<!-- Info Modal -->
@if (showInfoModal) {
<div class="modal-overlay" (click)="closeInfoModal()">
  <div
    class="modal-content w-full h-full lg:w-[90vw] lg:max-w-3xl lg:max-h-[90vh] lg:rounded-2xl flex flex-col overflow-hidden"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-shrink-0">
      <div class="flex items-center gap-3">
        <lucide-icon [img]="Info" class="w-7 h-7 text-accent-green" [strokeWidth]="2"></lucide-icon>
        <h2 class="text-xl sm:text-2xl font-bold text-text">
          {{ 'info.title' | translate }}
        </h2>
      </div>
      <button (click)="closeInfoModal()" class="btn btn-outline p-2 min-w-0" aria-label="Close">
        <lucide-icon [img]="X" class="w-6 h-6" [strokeWidth]="2"></lucide-icon>
      </button>
    </div>

    <!-- Content -->
    <div class="flex-1 overflow-y-auto space-y-6 pr-2">
      <!-- Welcome -->
      <div class="card p-4 sm:p-5">
        <h3 class="text-lg font-bold text-gold mb-2">
          {{ 'info.sections.welcome.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.welcome.content' | translate }}
        </p>
      </div>

      <!-- Unlocking -->
      <div class="card p-4 sm:p-5">
        <h3 class="text-lg font-bold text-gold mb-2">
          {{ 'info.sections.unlocking.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.unlocking.content' | translate }}
        </p>
      </div>

      <!-- Challenges -->
      <div class="card p-4 sm:p-5">
        <h3 class="text-lg font-bold text-gold mb-2">
          {{ 'info.sections.challenges.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.challenges.content' | translate }}
        </p>
      </div>

      <!-- Rewards -->
      <div class="card p-4 sm:p-5">
        <h3 class="text-lg font-bold text-gold mb-2">
          {{ 'info.sections.rewards.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.rewards.content' | translate }}
        </p>
      </div>

      <!-- Replay -->
      <div class="card p-4 sm:p-5">
        <h3 class="text-lg font-bold text-gold mb-2">
          {{ 'info.sections.replay.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.replay.content' | translate }}
        </p>
      </div>

      <!-- Christmas -->
      <div class="card p-4 sm:p-5 border-2 border-accent-green">
        <h3 class="text-lg font-bold text-accent-green mb-2">
          {{ 'info.sections.christmas.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.christmas.content' | translate }}
        </p>
      </div>

      <!-- Extras -->
      <div class="card p-4 sm:p-5">
        <h3 class="text-lg font-bold text-gold mb-2">
          {{ 'info.sections.extras.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.extras.content' | translate }}
        </p>
      </div>

      <!-- Pro Tip -->
      <div
        class="card p-4 sm:p-5 bg-opacity-50"
        style="
          background: linear-gradient(135deg, rgba(244, 211, 94, 0.1), rgba(42, 157, 143, 0.1));
        "
      >
        <h3 class="text-lg font-bold text-gold mb-2">
          {{ 'info.sections.tip.title' | translate }}
        </h3>
        <p class="text-text-muted text-sm sm:text-base leading-relaxed">
          {{ 'info.sections.tip.content' | translate }}
        </p>
      </div>

      <!-- Closing -->
      <div class="text-center py-4">
        <p class="text-text text-base sm:text-lg font-medium">{{ 'info.closing' | translate }}</p>
      </div>
    </div>
  </div>
</div>
}

<!-- Rewards Gallery Modal -->
@if (showRewardsGallery) {
<div class="modal-overlay" (click)="closeRewardsGallery()">
  <div
    class="modal-content w-full h-full lg:w-[90vw] lg:max-w-5xl lg:max-h-[90vh] lg:rounded-2xl flex flex-col overflow-hidden"
    (click)="$event.stopPropagation()"
  >
    <!-- Header -->
    <div class="flex items-center justify-between mb-6 flex-shrink-0">
      <div class="flex items-center gap-4">
        <h2 class="text-2xl sm:text-3xl font-bold text-text">
          üèÜ {{ 'rewards.galleryTitle' | translate }} üèÜ
        </h2>
      </div>
      <button
        (click)="closeRewardsGallery()"
        class="btn btn-outline p-2 min-w-0"
        aria-label="Close"
      >
        <lucide-icon [img]="X" class="w-6 h-6" [strokeWidth]="2"></lucide-icon>
      </button>
    </div>

    <!-- Rewards List -->
    <div class="flex-1 overflow-y-auto">
      <div class="space-y-4">
        @for (day of getSortedCalendarDays(); track day.day) {
        <div class="card p-4 sm:p-6">
          <div class="flex items-start gap-4">
            <!-- Day Badge -->
            <div
              class="flex-shrink-0 w-12 h-12 sm:w-16 sm:h-16 rounded-full bg-accent-red flex items-center justify-center"
            >
              <span class="text-lg sm:text-2xl font-bold text-white">{{ day.day }}</span>
            </div>

            <!-- Reward Content -->
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-2xl">{{ getGameIcon(day.challengeType || '') }}</span>
                <h3 class="text-lg sm:text-xl font-bold text-gold">
                  {{ 'calendar.dayLabel' | translate : { day: day.day } }}
                </h3>
                @if (hasVideoReward(day)) {
                <span class="text-sm bg-accent-green text-white px-2 py-0.5 rounded-full"
                  >üé¨ Video</span
                >
                } @if (hasAudioReward(day)) {
                <span class="text-sm bg-gold text-bg px-2 py-0.5 rounded-full">üéµ Audio</span>
                }
              </div>

              <!-- Fun Fact / Text Reward -->
              @if (getRewardText(day)) {
              <p class="text-sm sm:text-base text-text leading-relaxed">
                {{ getRewardText(day) | translate }}
              </p>
              }

              <!-- Video Reward -->
              @if (hasVideoReward(day) && day.reward?.videoUrl) {
              <div class="mt-4">
                <video
                  [src]="day.reward!.videoUrl"
                  controls
                  class="max-w-full h-auto rounded-lg shadow-lg"
                  style="max-height: 200px"
                  playsinline
                >
                  <source
                    [src]="day.reward!.videoUrl!"
                    [type]="'video/' + (day.reward!.videoType || 'mp4')"
                  />
                </video>
              </div>
              }

              <!-- Audio Reward -->
              @if (hasAudioReward(day) && day.reward?.audioUrl) {
              <div class="mt-4 space-y-3">
                <div class="flex items-center gap-3 bg-surface rounded-lg p-3">
                  <span class="text-2xl">üéµ</span>
                  <audio
                    [src]="day.reward!.audioUrl"
                    controls
                    class="flex-1 h-10"
                    controlsList="nodownload"
                  >
                    <source
                      [src]="day.reward!.audioUrl!"
                      [type]="'audio/' + (day.reward!.audioType || 'mp3')"
                    />
                  </audio>
                  <span class="text-2xl">üéµ</span>
                </div>
                @if (day.reward?.lyrics) {
                <details class="bg-surface rounded-lg">
                  <summary
                    class="cursor-pointer p-3 text-gold font-semibold flex items-center gap-2"
                  >
                    <span>üìù</span>
                    <span>{{ 'rewards.lyricsLabel' | translate }}</span>
                  </summary>
                  <pre
                    class="p-3 pt-0 text-sm text-text whitespace-pre-wrap font-sans leading-relaxed"
                    >{{ day.reward!.lyrics | translate }}</pre
                  >
                </details>
                }
              </div>
              }
            </div>
          </div>
        </div>
        }
      </div>
    </div>
  </div>
</div>
}
